@model RentCar.WebClient.Models.Cars.CarsViewModel
@{
    ViewData["Title"] = "Available Cars";
}

<link rel="stylesheet" href="~/css/cars.css" />

<div class="cars-container">
    <h1 class="page-title">Selamat Datang di Rental Mobil Kami</h1>

    <div class="controls-bar">

        <!-- Date Filter Section -->
        <div class="date-filter-section">
            <form method="get" id="dateForm" style="display: contents;">
                <div class="date-group">
                    <label>Pickup Date:</label>
                    <input type="date" 
                           name="rentDate" 
                           value="@Context.Request.Query["rentDate"]"
                           required />
                </div>

                <div class="date-group">
                    <label>Return Date:</label>
                    <input type="date" 
                           name="returnDate" 
                           value="@Context.Request.Query["returnDate"]"
                           required />
                </div>

                <div class="date-group">
                    <label>Filter Tahun Pembuatan</label>
                    <select type="year" name="yearFilter">
                        <option value="">Semua Tahun</option>
                        @for (int year = DateTime.Now.Year; year >= 1990; year--)
                        {
                            <option value="@year" selected="@(Model.YearFilter == year ? "selected" : null)">@year</option>
                        }
                    </select>
                </div>

                <button type="submit" class="search-button">Cari</button>
            </form>
        </div>

        <!-- Sorting Options -->
        <div class="sorting-controls">
            <div class="sort-dropdown">
                <button class="sort-button" onclick="toggleDropdown()">
                    Sort By: @Model.SortBy ▼
                </button>
                <div class="dropdown-menu" id="sortDropdown">
                    <a href="@Url.Action("Index", new { 
                           sortBy = "Name", 
                           sortOrder = Model.SortOrder, 
                           page = 1,
                           rentDate = Context.Request.Query["rentDate"],
                           returnDate = Context.Request.Query["returnDate"],
                           yearFilter = Model.YearFilter
                       })">
                       Name
                    </a>
                    <a href="@Url.Action("Index", new { 
                           sortBy = "Model", 
                           sortOrder = Model.SortOrder, 
                           page = 1,
                           rentDate = Context.Request.Query["rentDate"],
                           returnDate = Context.Request.Query["returnDate"],
                           yearFilter = Model.YearFilter
                       })">
                       Model
                    </a>
                    <a href="@Url.Action("Index", new { 
                           sortBy = "Year", 
                           sortOrder = Model.SortOrder, 
                           page = 1,
                           rentDate = Context.Request.Query["rentDate"],
                           returnDate = Context.Request.Query["returnDate"],
                           yearFilter = Model.YearFilter
                       })">
                       Year
                    </a>
                    <a href="@Url.Action("Index", new { 
                           sortBy = "Price", 
                           sortOrder = Model.SortOrder, 
                           page = 1,
                           rentDate = Context.Request.Query["rentDate"],
                           returnDate = Context.Request.Query["returnDate"],
                           yearFilter = Model.YearFilter
                       })">
                       Price
                    </a>
                </div>
            </div>

            <a href="@Url.Action("Index", new { 
                   sortBy = Model.SortBy, 
                   sortOrder = Model.SortOrder == "asc" ? "desc" : "asc", 
                   page = Model.CurrentPage,
                   rentDate = Context.Request.Query["rentDate"],
                   returnDate = Context.Request.Query["returnDate"],
                   yearFilter = Model.YearFilter
               })"
               class="sort-order-button">
                @if (Model.SortOrder == "asc")
                {
                    <span>↑ Ascending</span>
                }
                else
                {
                    <span>↓ Descending</span>
                }
            </a>
        </div>

        <div class="results-info">
            @if (Model.TotalCars > 0)
            {
                <p>
                    Showing @((Model.CurrentPage - 1) * 3 + 1)
                    - @Math.Min(Model.CurrentPage * 3, Model.TotalCars)
                    of @Model.TotalCars cars
                </p>
            }
            else
            {
                <p></p>
            }
        </div>
    </div>

    <div>
        @if (User.Identity?.IsAuthenticated == true)
        {
            <a href="@Url.Action("Index", "Cart")" class="btn-cart">Lihat Keranjang</a>
        }
        else
        {
            <a href="@Url.Action("Index", "Cart")" class="btn-cart-logged-out">Login untuk mengakses keranjang</a>
        }
    </div>

    <!-- Car Cards Grid -->
    <div class="cars-grid">
        @foreach (var car in Model.Cars)
        {
            <a href="@Url.Action(
                "Details", 
                "Car", 
                new {
                    id = car.Car_id,
                    rentDate = Context.Request.Query["rentDate"],
                    returnDate = Context.Request.Query["returnDate"]
                })" 
                class="car-card-link">
                <div class="car-card">
                    <div class="car-image">
                        @if (car.CarImages != null && car.CarImages.Any())
                        {
                            <img src="@car.CarImages.First().Image_link" alt="@car.Name">
                        }
                        else
                        {
                            <img src="/images/placeholder-car.jpg" alt="No image">
                        }
                    </div>
                    <div class="car-info">
                        <h3 class="car-name">@car.Name @(@car.Transmission.Equals("automatic", StringComparison.OrdinalIgnoreCase) ? "AT" : "MT") @car.Year</h3>
                        <div class="car-price">
                            <span class="price-label">Harga</span>
                            <span class="price-amount">Rp. @car.Price_per_day.ToString("N0") / hari</span>
                        </div>
                        <div class="details-button">Lihat Selengkapnya</div>
                    </div>
                </div>
            </a>
        }
    </div>

    @if (Model.TotalCars == 0 && Model.CarValidation == CarValidationStatus.Valid)
    {
        <div class="no-results">
            <p>Tidak ada mobil tersedia untuk disewa pada rentang waktu tersebut. Mohon dicek kembali nanti.</p>
        </div>
    }

    @if (Model.CarValidation == CarValidationStatus.MissingDates)
    {
        <div class="no-results">
            <p>Masukkan tanggal sewa dan tanggal kembali untuk melihat mobil yang tersedia untuk disewa.</p>
        </div>
    }
    else if (Model.CarValidation == CarValidationStatus.InvalidDateRange)
    {
        <div class="no-results">
            <p>Apakah Anda merupakan seorang penjelajah waktu?</p>
        </div>
    }

    <!-- Pagination -->
    @if (Model.TotalPages > 1)
{
    <nav class="pagination">
        <a href="@Url.Action("Index", new { 
               page = Model.CurrentPage - 1, 
               sortBy = Model.SortBy, 
               sortOrder = Model.SortOrder,
               rentDate = Context.Request.Query["rentDate"],
               returnDate = Context.Request.Query["returnDate"],
               yearFilter = Model.YearFilter
           })"
           class="page-link @(!Model.HasPreviousPage ? "disabled" : "")">
            Previous
        </a>

        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <a href="@Url.Action("Index", new { 
                   page = i, 
                   sortBy = Model.SortBy, 
                   sortOrder = Model.SortOrder,
                   rentDate = Context.Request.Query["rentDate"],
                   returnDate = Context.Request.Query["returnDate"],
                   yearFilter = Model.YearFilter
               })"
               class="page-link @(i == Model.CurrentPage ? "active" : "")">
                @i
            </a>
        }

        <a href="@Url.Action("Index", new { 
               page = Model.CurrentPage + 1, 
               sortBy = Model.SortBy, 
               sortOrder = Model.SortOrder,
               rentDate = Context.Request.Query["rentDate"],
               returnDate = Context.Request.Query["returnDate"],
               yearFilter = Model.YearFilter
           })"
           class="page-link @(!Model.HasNextPage ? "disabled" : "")">
            Next
        </a>
    </nav>
}
</div>

<script>
    function toggleDropdown() {
        document.getElementById('sortDropdown').classList.toggle('show');
    }

    window.onclick = function(event) {
        if (!event.target.matches('.sort-button')) {
            var dropdowns = document.getElementsByClassName('dropdown-menu');
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }
</script>

